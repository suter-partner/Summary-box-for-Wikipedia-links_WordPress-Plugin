/*!
 * Plugin Name: Summary box for Wikipedia links
 * Plugin URI: https://su-pa.net/wikiPrevBox/
 * Version: 1.1.0
 * Author: suter & partner
 * Author URI: https://su-pa.net/
 * License: GPL v3 or later
 * License URI: https://www.gnu.org/licenses/gpl-3.0.html 
 * Text Domain: summary-box-for-wikipedia-links
 * Description: Provides a preview for Wikipedia links with nice summary boxes when a reader hovers over or taps a word that is linked to a Wikipedia article.
 * 
 * su-pa.net, 25/11/2023, 1.0.1; 05/04/2024, 1.0.2; 21/07/2024, 1.0.3; 22/11/2024, 1.0.4; 19/03/2025, 1.1.0; Dominik Fehr, wikinick@su-pa.net
 */
!function(){"use strict";document.body.insertAdjacentHTML("afterbegin",'<article id="wikiPreviewBox" class="wikiPreviewBox"></article>');let showNoImages=!1,openLinkTarget="target='_blank'",wikiBoxWidth=300,wikiBoxMaxLenght=280,wikiBoxFontSize=.9,showWikipediaOrg=!0,strWikipediaOrg="</a> (wikipedia.org)",textDirection=document.dir||"";if(void 0!==document.currentScript.dataset.wikipreview){const objCustomParams=document.currentScript.dataset.wikipreview.split(",").reduce(((acc,item)=>{const[key,value]=item.split("=");return acc[key]=void 0===value||(isNaN(value)?value:parseFloat(value)),acc}),{}),{noimages:noimages,openlinkinsamewindow:openlinkinsamewindow,width:width,numberofchars:numberofchars,fontsize:fontsize,nowikilinknote:nowikilinknote}=objCustomParams;showNoImages=noimages||showNoImages,openLinkTarget=openlinkinsamewindow?"":openLinkTarget,wikiBoxWidth=Math.min(Math.max(parseInt(width||300),200),400),wikiBoxMaxLenght=Math.min(Math.max(parseInt(numberofchars||280),100),600),wikiBoxFontSize=Math.min(Math.max(parseFloat(fontsize||.9),.3),2),showWikipediaOrg=nowikilinknote?showWikipediaOrg=!1:showWikipediaOrg}let wikiTermPos,wikiTerm,whatArticle="",wikiArticleUrl="",wikiLang="",wikiPreviewBox=document.getElementById("wikiPreviewBox");wikiPreviewBox.style.width=wikiBoxWidth+"px",wikiPreviewBox.style.fontSize=wikiBoxFontSize+"em",wikiPreviewBox.style.zIndex=[...document.querySelectorAll`*`].reduce(((a,e,i,t,z=+window.getComputedStyle(e).zIndex||0)=>z>a?z:a),0)+1111,wikiPreviewBox.addEventListener("click",hideWikiBox),wikiPreviewBox.addEventListener("mouseover",showWikiBox),wikiPreviewBox.addEventListener("mouseout",hideWikiBox);let allWikiLinks=document.querySelectorAll("[href*='wikipedia.org']:not([href*='#nopreview'])"),allWithNopreview=document.querySelectorAll("[href*='#nopreview']");for(let z=0;z<allWithNopreview.length;z++)allWithNopreview[z].href=allWithNopreview[z].href.replace("#nopreview","");for(let i=0;i<allWikiLinks.length;i++)allWikiLinks[i].classList.add("wikiLink"),"rtl"===textDirection&&allWikiLinks[i].classList.add("wikiLink_rtl"),allWikiLinks[i].addEventListener("mouseover",(e=>{wikiTerm=e.currentTarget,wikiArticleUrl=wikiTerm.href,whatArticle=""+wikiArticleUrl.split("/").pop(),wikiLang=wikiArticleUrl.split(".")[0].split("//")[1],wikiTermPos=wikiTerm.getBoundingClientRect();let wikiBoxLeft=wikiTermPos.left-wikiBoxWidth/2+(wikiTermPos.right-wikiTermPos.left)/2;wikiBoxLeft<0&&(wikiBoxLeft=10);let winInnerWidth=window.innerWidth;winInnerWidth<wikiBoxWidth?wikiBoxLeft=winInnerWidth-wikiBoxWidth+(wikiBoxWidth-winInnerWidth):wikiBoxLeft+wikiBoxWidth>winInnerWidth&&(wikiBoxLeft=winInnerWidth-wikiBoxWidth-20),wikiPreviewBox.style.left=wikiBoxLeft+"px",getWikiPreviewData(whatArticle,wikiLang)}),!1),allWikiLinks[i].addEventListener("click",(event=>{event.preventDefault()})),allWikiLinks[i].addEventListener("mouseout",hideWikiBox);function sanitizeApiData(str){const allowedTags=["b","i","p","strong","ul","li","img","span","a","sup","sub","div","ol"];return str.replace(/<\/?([a-zA-Z0-9]+)(\s+[^>]*)?>/g,((match,tagName)=>(tagName=tagName.toLowerCase(),allowedTags.includes(tagName)?match:match.replace(/</g,"&lt;").replace(/>/g,"&gt;"))))}function getWikiPreviewData(whatArticle,whatLang="en"){const showThisImgAnyway=(whatArticle=(whatArticle.charAt(0).toUpperCase()+whatArticle.slice(1)).replace(/ /g,"_")).includes("#showimage");showThisImgAnyway&&(whatArticle=whatArticle.replace("#showimage",""));const dontShowThisImg=whatArticle.includes("#dontshowimage");dontShowThisImg&&(whatArticle=whatArticle.replace("#dontshowimage",""));let arrArticleSummary=[];navigator.onLine&&fetch(`https://${whatLang}.m.wikipedia.org/api/rest_v1/page/summary/${whatArticle}`).then((response=>{response.ok&&response.json().then((wikiSummData=>{const sumTit=sanitizeApiData(wikiSummData.title),sumHtml=sanitizeApiData(wikiSummData.extract_html),thumbnailSource=wikiSummData?.thumbnail?.source??"";arrArticleSummary=""!==thumbnailSource&&!showNoImages&&!dontShowThisImg||showThisImgAnyway?[`<img height="${sanitizeApiData((wikiSummData?.thumbnail?.height??0).toString())}" src="${sanitizeApiData(thumbnailSource)}"/>`,sumHtml,`https://${whatLang}.wikipedia.org/wiki/${whatArticle}`,sumTit]:["",sumHtml,`https://${whatLang}.wikipedia.org/wiki/${whatArticle}`,sumTit],function(arrArticleSum,textDirection){let wikiBoxContent="";if(wikiBoxContent=arrArticleSum[0],arrArticleSum[1].length<=wikiBoxMaxLenght)wikiBoxContent+=arrArticleSum[1],"."==wikiBoxContent.slice(-1)&&(wikiBoxContent=wikiBoxContent.substring(0,wikiBoxContent.length-1));else{let lastClosingTag=arrArticleSum[1].substr(arrArticleSum[1].lastIndexOf("<"),arrArticleSum[1].length);wikiBoxContent+="</p>"===lastClosingTag?arrArticleSum[1].substring(0,wikiBoxMaxLenght-3):arrArticleSum[1].substring(0,wikiBoxMaxLenght-9),"."==wikiBoxContent.slice(-1)&&(wikiBoxContent=wikiBoxContent.substring(0,wikiBoxContent.length-1)),wikiBoxContent+="&nbsp;..."+lastClosingTag}wikiPreviewBox.innerHTML=wikiBoxContent,showWikipediaOrg||(strWikipediaOrg="ltr"===textDirection?"<span class='wikiArrow_ltr'>&#x279C;</span></a>":"<span class='wikiArrow_rtl'>&#x279C;</span></a>");let wikiBoxfooter="<span class='wikiBoxfooter_"+textDirection+"'><a href='"+arrArticleSum[2]+"' "+openLinkTarget+" rel='noopener'>"+arrArticleSum[3]+strWikipediaOrg+"</span><a href='https://su-pa.net/wikiPrevBox/' target='_blank' rel='noopener' title='Summary box for Wikipedia links - click for info' alt='Summary box for Wikipedia links - click for info'><span class='wikiBoxLogo-w_"+textDirection+"'>W</span></a>";wikiBoxfooter=sanitizeApiData(wikiBoxfooter),wikiPreviewBox.insertAdjacentHTML("beforeend",wikiBoxfooter),wikiPreviewBox.getElementsByTagName("P")[0].setAttribute("lang",wikiLang),wikiPreviewBox.getElementsByTagName("P")[0].setAttribute("dir",textDirection),showWikiBox()}(arrArticleSummary,wikiSummData.dir)}))}))}function showWikiBox(){let wikiPreviewBoxHeight=wikiPreviewBox.getBoundingClientRect().height||400,wikiTermPosBottom=wikiTermPos.bottom,visibleHeight=window.innerHeight;wikiTermPosBottom<wikiPreviewBoxHeight?(wikiPreviewBox.style.top=wikiTermPosBottom+window.scrollY+"px",wikiTermPosBottom+wikiPreviewBoxHeight>visibleHeight&&(wikiPreviewBox.style.top=window.scrollY+"px")):wikiPreviewBox.style.top=wikiTermPos.top+window.scrollY-wikiPreviewBox.getBoundingClientRect().height+"px",wikiPreviewBox.style.opacity=1,wikiPreviewBox.style.visibility="visible"}function hideWikiBox(){wikiTerm.matches(":hover")||(wikiPreviewBox.style.opacity=0,wikiPreviewBox.style.visibility="hidden")}}();